services:
  app:
    build:
      target: dev
    environment:
      PORT: 8000
      DEBUG: "True"
      DJANGO_LOG_LEVEL: DEBUG
      PYTHONUNBUFFERED: 1
      SECRET_KEY: something-super-secret
      BUDGET_URL: https://budget.datasektionen.se
      DATABASE_URL: postgresql://cashflow:cashflow@db:5432/cashflow
      OIDC_PROVIDER: http://nyckeln:7003
      OIDC_ID: client-id
      OIDC_SECRET: client-secret
      REDIRECT_URL: http://localhost:8000/login/
      HIVE_URL: http://nyckeln:7004
      HIVE_SECRET: cashflow-secret
      SPAM_URL: http://spam:3000
      SPAM_API_KEY: spam-secrect
      RFINGER_API_URL: http://dock:9003
      RFINGER_API_KEY: rfinger-secret
      S3_ACCESS_KEY_ID: aws-id
      S3_SECRET_ACCESS_KEY: aws-secret
      S3_BUCKET_NAME: cashflow
      S3_REGION: eu-west-1
      S3_HOST: http://localhost:9090
    command: /app/run.sh
    init: true
    ports:
      - 8000:8000
    configs:
      - source: nginx.conf 
        target: /etc/nginx/nginx.conf
    volumes:
      - ./media:/app/media
    develop:
      watch:
        - path: .
          target: /app
          action: sync+restart
        - path: pyproject.toml
          action: rebuild
    depends_on:
      db:
        condition: service_healthy

  # Database
  db:
    image: postgres:18
    environment:
      POSTGRES_USER: cashflow
      POSTGRES_PASSWORD: cashflow
      POSTGRES_DB: cashflow
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "cashflow"]
      interval: 2s
      timeout: 2s
      retries: 3

  # S3
  s3:
    image: adobe/s3mock:latest
    environment:
      - COM_ADOBE_TESTING_S3MOCK_STORE_INITIAL_BUCKETS=cashflow
      - COM_ADOBE_TESTING_S3MOCK_STORE_REGION=eu-west-1
    ports:
      - 9090:9090

  # Spam
  spam:
    image: ghcr.io/datasektionen/spam-rs:latest
    ports:
      - 3000:3000
    environment:
      RUST_LOG: debug
      HOST_ADDRESS: 0.0.0.0
      PORT: 3000
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_REGION: aws-ses-v2-local
      AWS_ENDPOINT_URL: http://aws-ses:8005
      APP_SECRET: insert-app-secret
      HIVE_URL: http://nyckeln:7004/api/v1
      HIVE_SECRET: aaaa

  smtp:
    image: changemakerstudiosus/papercut-smtp
    container_name: smtp
    ports:
      - 8080:8080
      - 2525:2525
    environment:
      Urls: http://0.0.0.0:8080
      SmtpServer__Port: 2525

  aws-ses:
    container_name: aws-ses-v2-local
    hostname: aws-ses-v2-local
    image: ghcr.io/domdomegg/aws-ses-v2-local
    environment:
      AWS_SES_ACCOUNT: '{"SendQuota":{"Max24HourSend":1000000,"MaxSendRate":250,"SentLast24Hours":0}}'
      SMTP_TRANSPORT: '{"host":"smtp","port":2525,"secure":false}'
    working_dir: /srv/www/dist
    ports:
      - "8005:8005"
    expose:
      - 8005

  # Our mock systems
  nyckeln:
    image: ghcr.io/datasektionen/nyckeln-under-dorrmattan
    configs:
      - source: nyckeln.yaml
        target: /config.yaml
    ports:
      - 7003:7003
      - 7004:7004
  dock:
    image: ghcr.io/datasektionen/dock:latest
    configs:
      - source: dock.yaml
        target: /config.yaml
    ports:
      - 9003:9003

configs:
  nginx.conf:
    content: | 
      events {}

      http {
        server {
          listen 7003;

          location / {
            proxy_pass http://nyckeln:7003;
          }
        }
        server {
          listen 9090;
          client_max_body_size 100M;

          location / {
            proxy_pass http://s3:9090;
          }
        }
      }

  dock.yaml:
    content: |
      rfinger:
        default: http://localhost:9003
        pictures:
          turetek:
            regular: https://thskth.se/wp-content/uploads/2023/06/ths-logo-bla-01-300x294-1.png
            small: https://thskth.se/wp-content/uploads/2019/12/ths-logo-svart-01.png
          diadat:
            regular: https://dsekt-assets.s3.amazonaws.com/logotyp
            small: https://dsekt-assets.s3.amazonaws.com/logotyp
          marmed:
            regular: https://storage.googleapis.com/medieteknik-static/static/logos/logo.webp
            small: https://storage.googleapis.com/medieteknik-static/static/logos/logo.webp

  
  nyckeln.yaml:
    content: |
      clients:
        - id: "client-id"
          secret: "client-secret"
          redirect_uris:
            - http://localhost:8000/login/

      users:
        - ug_kth_id: some-id
          kth_id: turetek
          email: turetek@kth.se
          first_name: Ture
          family_name: Teknolog
        - ug_kth_id: some-other-id
          kth_id: diadat
          email: diadat@kth.se
          first_name: Diana
          family_name: Datalog
          year_tag: D-83
        - ug_kth_id: yet-anouther-id
          kth_id: marmed
          email: marmed@kth.se
          first_name: Martin
          family_name: Median
          year_tag: Me-00

      hive:
        tokens:
          - secret: spam-secrect
            permissions:
            - id: send
          - secret: rfinger-secrect
            permissions:
            - id: get
        groups:
          - name: Kass√∂r
            id: kassor
            domain: example.com
            members:
              - turetek
            permissions: 
              - id: accounting
                scope: "*"
              - id: attest
                scope: "*"
              - id: confirm
              - id: delete 
              - id: edit-invoice
              - id: moderate-comments
              - id: pay
              - id: unattest
              - id: unconfirm
              - id: view-all-payments
          - name: Konglig Lokalchef
            id: lokalchef
            domain: example.com
            members:
              - diadat
            permissions:
              - id: attest
                scope: Sektionslokalsgruppen
          # - name: METAdorerna
          #   id: metadorerna
          #   domain: example.com
          #   members:
          #     - marmed
